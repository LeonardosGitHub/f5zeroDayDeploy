# F5 Zero Day Deploy Example
## POC use only - not for production use. Must be changed/updated/tested to match your environments needs.

<br>

- High-level description what the playbook accomplishes:
    - Obtain's inventory from BIG-IQ
    - Has each BIG-IP request a Signature file update
    - Installs the new signature file
    - Creates a new Signature Set which includes the signatures specified in playbook
    - Adds new Signature Set to a Parent policy
    - Adds new Signature Set to all the Child policies that declined inheritance of attack signatures from Parent policy

<br>

- Prerequistes, assumptions, statements:
    - BIG-IQ is available and manages BIG-IPs with Security Services discovered.
    - This operation changes the BIG-IPs directly, BIG-IQ will need to be synced with the changes made directly on the BIG-IPs. 
    - The "rest-proxy" functionality must be enabled for each BIG-IP within BIG-IQ. https://support.f5.com/csp/article/K79939355
    - Each BIG-IP should be able to reach downloads.f5.com.  This can be directly or via an explicit forward proxy. https://support.f5.com/csp/article/K10942531
    - This playbook creates a NEW signature set, it does not add to an existing signature set
    - I've set the BIG-IPs to disable autodownload of live updates
        - tmsh sys db liveupdate.autodownload value disable
    - I found that the UUID of the same Parent policy, Child policy, and specific Signature Set are the same across BIG-IPS.
    - See folder "artifacts_examples" for examples of files playbook creates
    - Articles used to help create the playbook/tasks:
        - K82512024: Managing BIG-IP ASM Live Updates (14.1.x and later) https://support.f5.com/csp/article/K82512024
        - K62654042: Use the iControl REST API to create and apply attack signatures and signature sets https://support.f5.com/csp/article/K62654042
        - K79939355: Enabling BIG-IQ Centralized Management as a REST proxy for BIG-IP devices https://support.f5.com/csp/article/K79939355
        - K10942531: How to configure BIG-IP to run system updates via proxy https://support.f5.com/csp/article/K10942531
        - K60640453: Enforcing attack signatures with iControl https://support.f5.com/csp/article/K60640453?utm_source=f5support&utm_medium=RSS
        - F5 BIG-IQ API https://clouddocs.f5.com/products/big-iq/mgmt-api/v0.0/
        

<br>

- Playbook needs a few variables populated before running, playbook is located in the folder "playbooks"::
    - "bigiq" - BIG-IQ IP address or FQDN
    - "user" - Username needed to authenticate to BIG-IQ
    - "loginProviderName" - this is set to local but can be changed. This refers to the method of user authentication configured on the target BIG-IQ system. This option is required when the BIG-IQ system is configured with a remote authentication method. https://support.f5.com/csp/article/K04452074
    - "sigSetName" - Add the name that you would like for the signature set.  This can be a static value or autogenerated, the playbook shows an example of this being autogenerated.
    - "newSigFileName" - this is the name of the recently released Signature file, it can be obtained from downloads.f5.com.  This is used to verify the file downloaded by the BIG-IP matches what you expect to be downloaded. The playbook has an example file name.
    - "parentPolicyName" - This is the name of the Parent Policy that you wish to target. 
    - "signatureIds" - This is a list of Signature IDs that you wish to add to the newly created Signature Set

<br>

- Playbook prompts user for "password" to authenticate to BIG-IQ

<br>

- To start playbook you can use the following:
    - ansible-playbook playbooks/zeroDay_playbook.yml
    - It's possible to run parts of the playbook based on tags, for example if you want to only want to check if the currently installed signature file matches what you want/expect you can run the following:
        - ansible-playbook playbooks/zeroDay_playbook.yml --tags preCheck
        - the tags are associated with each role, look at the playbook for each tag name
        - It's possible that one role relys on data/variables from other roles, so you may have to run more than one role for it to be successful

<br>

- Roles overview:
    - cleanUpBeforePlay
        - This will delete the folder "artifacts" then re-add to make sure the artifacts generated by the playbook are current.
    - bigiqToken
        - This authenticates to BIG-IQ and obtains and saves the token to a variable
    - bigipInvOnBigiq
        - This will get a list of all the BIG-IP devices that BIG-IQ is manging.
        - From the information returned from BIG-IQ it will determine if ASM/Security services have been discovered
        - The playbook will then setup a dictionary variable with the following information for each BIG-IP:
            - "ASMdiscovered": true|false
            - "bigipName": "_nameOFBigIP_"
            - "machineId": "28b8a51f-f09a-4d99-a2ca-acc82df35894"
            - "managementAddress": "192.168.1.189"
            - "version": "16.1.0"
    - checkIfNewSigFileAlreadyInstalled
        - This will check the currently installed Signature file with the expected Signature file, if they match the next role, attackSigFileUPdate, will be skipped.
    - attackSigFileUpdate
        - Asks each BIG-IP to go fetch most recent signature file
        - Once the BIG-IP downloads the most recent file it'll "staged" the file, the playbook will verify it's staged
        - It then will check the name of the signature file against what was provided originally in the playbook.  If they do not match the playbook will fail. 
        - It then asks the BIG-IPs to start installation of signature file
        - It then verifies the signature file has been installed
    - signatureSets
        - This will get the "selfLink" of each signature that was provided originally in the playbook
        - It then gets the UUID of each signature
        - It then creates a Signature Set and includes the signatures specified
    - updatePolicies
        - This goes out to get the Parent policy ID information
        - Applies the recently created Signature Set to the Parent Policy
        - Finds all Child policies tied to the Parent policy and whether that Child has declined inheritance of attack signatures. 
        - Applies the recently created Signature Set to the Child Policies that have declined inheritance of attack signatures.
    - enforceSignatures
        - This role will enforce all signatures specified in playbook on each child policy, regarless of inheritance setting. 
    - applyPolicies
        - "Apply Policy" (pushes changes to production) for the parent policy which also applies the policy to all the Child Policies.
    - bigiqRefreshToken
        - This role is NOT referenced in the main playbook BUT this is referenced by other roles to perform a refresh of the BIG-IQ token before any REST calls are performed. 

<br>

